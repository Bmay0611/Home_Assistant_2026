intent_script:
  AskChatGPT:
    speech:
      text: "Okay."
    action:
      - service: conversation.process
        data:
          text: "{{ query }}"
        response_variable: chat
        continue_on_error: true

      - variables:
          reply: >-
            {% set r = chat %}
            {% if r is mapping and r.response is defined and r.response.speech is defined %}
              {% set s = r.response.speech %}
              {% if s is mapping and s.plain is defined and s.plain.speech is defined %}
                {{ s.plain.speech | string }}
              {% elif s is string %}
                {{ s | string }}
              {% else %}
                Sorry, I could not get a readable response.
              {% endif %}
            {% else %}
              Sorry, I could not reach ChatGPT right now.
            {% endif %}

      - service: script.speak_on_sonos
        data:
          message: "{{ reply }}"
